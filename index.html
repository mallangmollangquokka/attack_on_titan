<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <script>
    (function () {
      // ====== 이 부분만 브로커 설정에 맞게 바꾸면 됨 ======
      const host  = "damoa.io";                   // MQTT 브로커 주소
      const port  = 9002;                         // ❗ WSS 포트 (일반적으로 9002)로 변경 ❗
      const topic = "ewha/2567018/attack_on_titan"; // 구독할 토픽
      const useTLS = true;                        // ❗ WSS를 위해 true로 변경 ❗
      // ===============================================

      const statusEl = document.getElementById("mqtt-status").querySelector("span");
      const topicEl  = document.getElementById("mqtt-topic").querySelector("code");
      const lastEl   = document.getElementById("mqtt-last");
      const logEl    = document.getElementById("mqtt-log");

      topicEl.textContent = topic;

      let client = null;

      function appendLog(text) {
        const div = document.createElement("div");
        div.className = "mqtt-log-entry";
        div.textContent = text;
        // 새 메시지가 위로 오도록
        logEl.prepend(div);
      }

      function onConnect() {
        statusEl.textContent = "연결됨 (" + host + ":" + port + ")";
        try {
          client.subscribe(topic);
          appendLog("[INFO] Subscribed to: " + topic);
        } catch (e) {
          appendLog("[ERROR] subscribe 실패: " + e);
        }
      }

      function onConnectionLost(responseObject) {
        if (responseObject && responseObject.errorMessage) {
          statusEl.textContent = "연결 끊김, 재연결 시도 중... (" + responseObject.errorMessage + ")";
          appendLog("[WARN] Connection lost: " + responseObject.errorMessage);
        } else {
          statusEl.textContent = "연결 끊김, 재연결 시도 중...";
          appendLog("[WARN] Connection lost (unknown reason)");
        }
        // 3초 후 재연결 시도
        setTimeout(connectMQTT, 3000);
      }

      function onMessageArrived(message) {
        const now = new Date().toLocaleTimeString();
        const payload = message.payloadString;
        const line = "[" + now + "] (" + message.destinationName + ") " + payload;

        lastEl.textContent = line;
        appendLog(line);
      }

      function connectMQTT() {
        const clientId = "web-" + Math.random().toString(16).substr(2, 8);
        statusEl.textContent = "연결 시도 중... (" + host + ":" + port + ", clientId=" + clientId + ")";

        try {
          // path를 따로 쓰지 않는 기본 형태
          // useSSL: useTLS가 true이므로 wss:// 프로토콜이 사용됨
          client = new Paho.MQTT.Client(host, Number(port), clientId);

          client.onConnectionLost = onConnectionLost;
          client.onMessageArrived = onMessageArrived;

          client.connect({
            useSSL: useTLS,
            timeout: 5,
            onSuccess: onConnect,
            onFailure: function (err) {
              statusEl.textContent = "연결 실패: " + err.errorMessage + " (3초 후 재시도)";
              appendLog("[ERROR] Connect failed: " + err.errorMessage);
              setTimeout(connectMQTT, 3000);
            }
          });
        } catch (e) {
          statusEl.textContent = "연결 오류 발생: " + e;
          appendLog("[ERROR] Exception: " + e);
          setTimeout(connectMQTT, 3000);
        }
      }

      // 페이지 로드되면 바로 연결 시도
      connectMQTT();
    })();
  </script>
